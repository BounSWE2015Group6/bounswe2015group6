<!doctype html>
<html>
<head>
  <title>HodgePodge</title>

  <script src="js/jquery-1.11.3.min.js"></script>
  <script src="js/vis.min.js"></script>
  <link rel="stylesheet" href="css/vis.min.css">

  <script src="js/jquery.cookie.js"></script>

  <style type="text/css">
    html, body {
      margin: 0;
      padding: 0;
      border: 0;
    }
    #mynetwork {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
/*      width: 100%;
      height: 800px;*/
      /*border: none;*/
    }
    #operation {
      font-size:28px;
    }
    #network-popUp {
      display:none;
      position:absolute;
      top:350px;
      left:170px;
      z-index:299;
      width:250px;
      height:120px;
      background-color: #f9f9f9;
      border-style:solid;
      border-width:3px;
      border-color: #5394ed;
      padding:10px;
      text-align: center;
    }
    #sidebar, #content {
      position: absolute;
    }
    #sidebar {
      top: 0px;
      width: 0px;
      bottom: 0px;
      background:green;
    }
    #content {
      top: 0px;
      left: 0px;
      right: 0;
      bottom: 0px;
    }
  </style>
</head>
<body>

<div id="sidebar"><button>close sidebar</button></div>
<div id="content">
  <div id="network-popUp">
    <span id="operation">node</span> <br>
    <table style="margin:auto;">
      <tr style="display:none">
      <td>Id</td><td ><input id="node-id" value="new value" /></td>
    </tr>
      <tr>
        <td>Name</td><td><input id="node-label" value="new value" /></td>
      </tr>
      <tr>
        <td>Tags</td><td><input id="node-tags" value="" /></td>
      </tr>
    </table>
    <input type="button" value="save" id="saveButton" />
    <input type="button" value="cancel" id="cancelButton" />
  </div>

  <div id="mynetwork"></div>
</div>



<script type="text/javascript">

var api = 'http://ec2-52-27-36-39.us-west-2.compute.amazonaws.com:8080';
// var lastTopicId;

$( document ).ready(function() {


  var nodesDataset;
  var edgesDataset

  $.when(

    $.get(api + "/api/topic/topics", function(data) {


      // var max = 0;                
      // $.map(data, function (obj) {
      //   if (obj.id > max)
      //     max = obj.id;
      // });

      // lastTopicId = max + 1;

      nodesDataset = new vis.DataSet(data);
    }),

    $.get(api + "/api/edge/edges", function(data) {
      edgesDataset = new vis.DataSet(data);
    })

  ).then(function() {
    showGraph(nodesDataset, edgesDataset);
  });

});

function showGraph(nodesDataset, edgesDataset) {

  var container = document.getElementById('mynetwork');

  var data = {
    nodes: nodesDataset,
    edges: edgesDataset
  };

  var options = {
    physics: {
      enabled: true
    },
    nodes: {
      shape: 'dot',
      scaling: {
        customScalingFunction: function (min,max,total,value) {
          return value/total;
        },
        min:5,
        max:150
      },

      // scaling: {
      //   min: 10,
      //   max: 30
      // },
      font: {
        size: 12,
        face: 'Tahoma'
      }
    },
    edges: {
      // width: 0.15,
      smooth: {
        type: 'continuous'
      }
    },
    interaction: {
      navigationButtons: true,
      keyboard: true,
      hover: true
      // hideEdgesOnDrag: true
    },
    manipulation: {
      initiallyActive: true,
      addNode: function (data, callback) {
        // filling in the popup DOM elements
        document.getElementById('operation').innerHTML = "Add Topic";
        document.getElementById('node-id').value = data.id;
        document.getElementById('node-label').value = data.label;
        document.getElementById('saveButton').onclick = saveData.bind(this, data, callback);
        document.getElementById('cancelButton').onclick = clearPopUp.bind();
        document.getElementById('network-popUp').style.display = 'block';
      },
      editNode: function (data, callback) {
        // filling in the popup DOM elements
        document.getElementById('operation').innerHTML = "Edit Node";
        document.getElementById('node-id').value = data.id;
        document.getElementById('node-label').value = data.label;
        document.getElementById('saveButton').onclick = saveData.bind(this, data, callback);
        document.getElementById('cancelButton').onclick = cancelEdit.bind(this,callback);
        document.getElementById('network-popUp').style.display = 'block';
      },
      addEdge: function (data, callback) {
        if (data.from == data.to) {
          // var r = confirm("Do you want to connect the node to itself?");
          // if (r == true) {
          //   callback(data);
          // }
        }
        else {
          callback(data);

          $.ajax({
            method: "POST",
            url: api + "/api/edge/create?source=" + data.from + "&dest=" + data.to,
            contentType: "application/json",
            dataType: "json"
            // data: { 
            //   source: data.from,
            //   dest: data.to
            // }
          })
          .done(function( data ) {
            
            console.log(data);

          })
          .fail(function( data ) {
              console.log(data);
          });
        }
      },
      deleteNode: function (data, callback) {
        callback(data);
        var nodeId = data.nodes[0];

        $.get(api + "/api/topic/delete?id=" + nodeId, function(data) {

        })
      }
    },
    autoResize: true,
    height: '100%',
    layout:{
      randomSeed:2
    }
  };

  var network = new vis.Network(container, data, options);

  network.on('select', function(params) {

    $('#content').animate({left: 300});

    console.log(params.nodes);
  });
}

function clearPopUp() {
  document.getElementById('saveButton').onclick = null;
  document.getElementById('cancelButton').onclick = null;
  document.getElementById('network-popUp').style.display = 'none';
}

function cancelEdit(callback) {
  clearPopUp();
  callback(null);
}

function saveData(data,callback) {
  data.id = document.getElementById('node-id').value;
  // data.id = lastTopicId;
  data.label = document.getElementById('node-label').value;
  var tags = document.getElementById('node-tags').value;
  clearPopUp();
  callback(data);

  var tagsarray = tags.split(',');

  $.ajax({
    method: "POST",
    url: api + "/api/topic/create",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({ 
      ownerId: $.cookie('id'),
      title: data.label,
      tags: tagsarray
    })
  })
  .done(function( data ) {
    
    console.log(data);

  })
  .fail(function( data ) {
      console.log(data);
  });
}

$( "button" ).click(function() {
  $('#content').animate({left: 0});
});
</script>

</body>
</html>